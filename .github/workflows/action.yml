name: Hexo Auto-Deploy
on:
  push:
    branches: 
      - master

jobs:
  build:
    name: Hexo Auto-Deploy by GitHub Actions
    runs-on: ubuntu-latest

    steps:
    - name: 1. git checkout...
      uses: actions/checkout@v4
      
    - name: 2. setup nodejs...
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'  # 使用 LTS 版本

    - name: 3. Cache node modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: 4. Clean npm cache if needed
      run: npm cache clean --force
      if: steps.cache.outputs.cache-hit != 'true'

    - name: 5. Install dependencies with retry
      run: |
        npm install hexo-cli -g
        n=0
        until [ $n -ge 3 ]; do
          n=$[$n+1]
          sleep 1
        done
        if [ $n -eq 3 ]; then echo "Install failed after 3 attempts"; exit 1; fi

    - name: 6. hexo generate public files...
      run: |
        hexo clean
        hexo generate  

    - name: 7. hexo deploy ...
      env: 
        GITHUB_REPO: github.com/PGzxc/PGzxc.github.io.git
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        hexo deploy --generate