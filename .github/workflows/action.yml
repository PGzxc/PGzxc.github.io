name: Hexo Auto-Deploy
on:
  push:
    branches: 
      - master

jobs:
  build:
    name: Hexo Auto-Deploy with Yarn
    runs-on: ubuntu-latest

    steps:
    - name: 1. Git checkout
      uses: actions/checkout@v4
      
    - name: 2. Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'yarn'  # 自动缓存 Yarn 依赖

    - name: 3. Install Yarn (if needed)
      run: |
        if ! command -v yarn &> /dev/null; then
          npm install -g yarn@stable
        fi

    - name: 4. Verify yarn.lock exists
      run: |
        if [ ! -f "yarn.lock" ]; then
          echo "Error: yarn.lock not found! Please generate it locally first."
          exit 1
        fi

    - name: 5. Install dependencies with Yarn
      run: |
        yarn install --frozen-lockfile --non-interactive --verbose
        # 如果需要强制锁定版本
        # yarn add stylus@0.54.8 --exact --force

    - name: 6. Hexo generate public files
      run: |
        yarn global add hexo-cli
        hexo clean
        hexo generate  

    - name: 7. Hexo deploy
      env: 
        GITHUB_REPO: github.com/PGzxc/PGzxc.github.io.git
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        hexo deploy --generate